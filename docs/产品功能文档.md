# 鸡王争霸赛 - 完整产品功能文档

> ikuncode 开发者实战大赏平台
>
> 版本：v1.2 | 更新日期：2025-12-27

---

## 目录

1. [项目概览](#1-项目概览)
2. [系统架构](#2-系统架构)
3. [用户角色与权限](#3-用户角色与权限)
4. [核心功能模块](#4-核心功能模块)
5. [亮点功能：码神挑战](#5-亮点功能码神挑战)
6. [数据库设计](#6-数据库设计)
7. [前端页面架构](#7-前端页面架构)
8. [API 设计规范](#8-api-设计规范)
9. [部署与运维](#9-部署与运维)
10. [业务流程图](#10-业务流程图)
11. [常见问题](#11-常见问题)

---

## 1. 项目概览

### 1.1 产品定位

**鸡王争霸赛**是一个面向开发者的创意编程比赛平台，集成了：

- 比赛报名与作品提交
- 社区公投与评审系统
- 积分经济与游戏化激励
- 社交互动与竞猜娱乐

### 1.2 核心价值

| 维度 | 价值点 |
|------|--------|
| **参赛者** | 展示技术实力，赢取奖品，获得曝光 |
| **观众** | 发现优秀项目，参与互动，赚取积分 |
| **平台** | 聚集开发者社区，推广 API 产品 |

### 1.3 技术栈

| 层级 | 技术选型 |
|------|----------|
| 前端 | React 18 + Vite + Tailwind CSS + Zustand |
| 后端 | FastAPI + SQLAlchemy Async + Pydantic |
| 数据库 | MySQL 8.0 + Redis 7 |
| 认证 | JWT + OAuth 2.0 (Linux.do / GitHub) |
| 部署 | Docker + Nginx + 自动化 Webhook |

---

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户端                                │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │
│  │ 首页    │  │ 活动中心 │  │ 参赛中心 │  │ 管理后台 │        │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘        │
└───────┼────────────┼────────────┼────────────┼──────────────┘
        │            │            │            │
        ▼            ▼            ▼            ▼
┌─────────────────────────────────────────────────────────────┐
│                     Nginx 反向代理                           │
│              (SSL/负载均衡/静态资源缓存)                      │
└─────────────────────────┬───────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        ▼                 ▼                 ▼
┌───────────────┐ ┌───────────────┐ ┌───────────────┐
│   Frontend    │ │   Backend     │ │   Webhook     │
│   (React)     │ │   (FastAPI)   │ │   (Flask)     │
│   Port:80     │ │   Port:8000   │ │   Port:9000   │
└───────────────┘ └───────┬───────┘ └───────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        ▼                 ▼                 ▼
┌───────────────┐ ┌───────────────┐ ┌───────────────┐
│    MySQL      │ │    Redis      │ │  Third-party  │
│   (持久化)    │ │   (缓存)      │ │  (OAuth/API)  │
└───────────────┘ └───────────────┘ └───────────────┘
```

### 2.2 服务模块

| 服务 | 端口 | 功能 |
|------|------|------|
| nginx | 80/443 | 反向代理、SSL、静态资源 |
| frontend | 80 | React 前端应用 |
| backend | 8000 | FastAPI 后端 API |
| webhook | 9000 | GitHub Webhook 自动部署 |
| mysql | 3306 | 主数据库 |
| redis | 6379 | 缓存、会话 |

---

## 3. 用户角色与权限

### 3.1 角色定义

| 角色 | 标识 | 权限范围 | 获取方式 |
|------|------|----------|----------|
| **管理员** | ADMIN | 系统全权 | 后台指定 |
| **评审员** | REVIEWER | 作品评审 | 管理员邀请 |
| **参赛者** | CONTESTANT | 报名参赛 | 用户选择 |
| **观众** | SPECTATOR | 浏览投票 | 默认角色 |

### 3.2 权限矩阵

| 功能 | 观众 | 参赛者 | 评审员 | 管理员 |
|------|:----:|:------:|:------:|:------:|
| 浏览作品 | ✅ | ✅ | ✅ | ✅ |
| 投票 | ✅ | ✅ | ✅ | ✅ |
| 打气互动 | ✅ | ✅ | ✅ | ✅ |
| 参与活动 | ✅ | ✅ | ✅ | ✅ |
| 竞猜下注 | ✅ | ✅ | ✅ | ✅ |
| 报名参赛 | ❌ | ✅ | ❌ | ✅ |
| 提交作品 | ❌ | ✅ | ❌ | ✅ |
| 作品评分 | ❌ | ❌ | ✅ | ✅ |
| 用户管理 | ❌ | ❌ | ❌ | ✅ |
| 系统配置 | ❌ | ❌ | ❌ | ✅ |

### 3.3 角色选择流程

```
新用户登录
    │
    ▼
┌─────────────────┐
│  角色选择引导   │
│                 │
│  ○ 我要参赛    │ ──→ CONTESTANT
│  ○ 我来观摩    │ ──→ SPECTATOR
└─────────────────┘
```

---

## 4. 核心功能模块

### 4.1 认证系统

#### 4.1.1 登录方式

| 方式 | 说明 | 优先级 |
|------|------|--------|
| 本地账号 | 用户名/邮箱 + 密码 | 主要 |
| Linux.do OAuth | 社区账号一键登录 | 主要 |
| GitHub OAuth | 开发者账号绑定/登录 | 次要 |

#### 4.1.2 认证流程

```
用户登录/注册
    │
    ├── 本地账号校验（用户名/邮箱 + 密码）
    └── OAuth 授权（Linux.do / GitHub）
    │
    ▼
创建/更新用户
    │
    ▼
签发 JWT Token
    │
    ▼
重定向前端 + Token
```

#### 4.1.3 Token 规格

- **有效期**：7 天
- **刷新机制**：滑动刷新
- **刷新接口**：`/auth/refresh`
- **存储位置**：localStorage + Zustand

#### 4.1.4 账号安全与绑定

- 支持本地密码设置/修改（修改需旧密码）
- 支持邮件找回密码（重置链接有效期可配置）
- 支持 Linux.do / GitHub 账号绑定
- 绑定冲突时提示合并确认（Linux.do）

#### 4.1.5 风控与安全挑战

- 登录/注册/找回密码等接口内置限流
- 触发式挑战：PoW / JS Challenge / 验证码（支持监控与强制模式）

---

### 4.2 积分系统

#### 4.2.1 积分获取

| 途径 | 积分 | 频率 | 说明 |
|------|------|------|------|
| 注册奖励 | 500 | 一次性 | 新用户激励 |
| 每日签到 | 100 | 每日 | 基础签到奖励 |
| 连续签到 3天 | +50 | 里程碑 | 额外奖励 |
| 连续签到 7天 | +100 | 里程碑 | 额外奖励 |
| 连续签到 30天 | +300 | 里程碑 | 额外奖励 |
| 接收打气 | 100~500 | 每次 | 根据打气类型 |
| 竞猜获胜 | 动态 | 每次 | 赔率计算 |
| 成就解锁 | 50~500 | 每个 | 根据稀有度 |
| 任务完成 | 配置 | 每个 | 日/周任务 |

#### 4.2.2 积分消费

| 途径 | 消费 | 说明 |
|------|------|------|
| 抽奖 | 20 | 转盘抽奖 |
| 刮刮乐 | 20 | 购买卡片 |
| 扭蛋机 | 50 | 扭一次 |
| 老虎机 | 30 | 转一次 |
| 竞猜下注 | 10~上限 | 自定义金额 |
| 商城兑换 | 商品价格 | 兑换券/道具 |

#### 4.2.3 数据模型

```
UserPoints (余额缓存)
├── balance: 当前余额
├── total_earned: 累计获得
└── total_spent: 累计消费

PointsLedger (流水记录)
├── amount: 变动金额 (+/-)
├── reason: 变动原因 (26种)
├── request_id: 幂等ID
└── created_at: 时间戳
```

---

### 4.3 比赛管理

#### 4.3.1 比赛生命周期

```
UPCOMING ──→ SIGNUP ──→ SUBMISSION ──→ VOTING ──→ ENDED
(即将开始)   (报名中)    (提交作品)     (投票中)   (已结束)
```

#### 4.3.2 报名流程

```
填写报名表
    │
    ├── 项目名称 *
    ├── 项目简介 *
    ├── 详细描述
    ├── 实现计划
    ├── 技术栈
    └── 联系方式
    │
    ▼
保存草稿 (DRAFT)
    │
    ▼
提交报名 (SUBMITTED)
    │
    ▼
管理员审核
    │
    ├── 通过 (APPROVED)
    └── 拒绝 (REJECTED)
```

#### 4.3.3 作品提交

**必须材料（5项）**：

| 序号 | 材料类型 | 格式要求 |
|------|----------|----------|
| 1 | 项目源码 URL | GitHub/Gitee 链接 |
| 2 | 演示视频 | MP4/AVI，≤500MB |
| 3 | 项目文档 | Markdown 格式 |
| 4 | API 调用截图 | PNG/JPG |
| 5 | API 调用日志 | 文本/截图 |

**提交状态流转**：
```
DRAFT → VALIDATING → SUBMITTED → APPROVED/REJECTED
```

#### 4.3.4 作品部署体系（Project）

- 参赛者创建作品（Project），补充简介与仓库信息
- 提交镜像 digest（Project Submission），进入部署队列
- Worker 拉取镜像并执行健康检查，失败自动清理
- 部署成功写入访问域名，作品入口页可直接访问

---

### 4.4 评审系统

#### 4.4.1 评审机制

- 多评审员独立评分（1-100分）
- 去掉最高分和最低分
- 计算剩余评分的平均值
- 支持评审意见反馈

#### 4.4.2 评审界面

评审员可查看：
- 作品基本信息
- 所有附件材料
- 项目源码链接
- 其他评审员评分（匿名）

#### 4.4.3 评审榜与公示

- 评审榜按最终得分排序，3 人以上去掉最高最低取平均
- 公示页展示 Top3 与完整榜单，支持查看详情

---

### 4.5 投票系统

#### 4.5.1 投票规则

- 每人每作品限投 1 票
- 可随时取消投票
- 投票数实时统计
- 投票截止由比赛阶段控制

#### 4.5.2 排行榜

- 实时票数排名
- 支持筛选（按技术栈、按时间）
- 展示投票趋势

---

### 4.6 打气互动

#### 4.6.1 打气类型

| 类型 | Emoji | 分值 | 积分反馈 |
|------|-------|------|----------|
| CHEER | 👊 | 1 | 100 |
| COFFEE | ☕ | 2 | 150 |
| ENERGY | ⚡ | 3 | 200 |
| PIZZA | 🍕 | 4 | 300 |
| STAR | ⭐ | 5 | 500 |

#### 4.6.2 打气规则

- 每人每天每选手限打气 1 次（按类型）
- 支持 200 字留言
- 被打气者获得积分奖励
- 打气不影响比赛评分

#### 4.6.3 作品互动（点赞/收藏）

- 点赞/收藏仅针对已上线作品
- 互动接口限流，防止刷榜
- 支持点赞榜与收藏榜展示

---

### 4.7 活动中心

#### 4.7.1 抽奖系统

**玩法**：
- 消耗 20 积分 / 使用抽奖券
- 转盘随机停止
- 按权重概率中奖

**奖品类型**：积分、API Key、道具、谢谢参与

#### 4.7.2 刮刮乐

**玩法**：
- 消耗 20 积分购买卡片 / 使用刮刮乐券
- Canvas 实现刮开效果
- 刮开面积 > 50% 显示结果

#### 4.7.3 扭蛋机

**玩法**：
- 消耗 50 积分 / 使用扭蛋券
- 动画展示扭蛋过程
- 弹出奖品展示

**奖品稀有度**：普通 → 稀有 → 史诗 → 传说

#### 4.7.4 老虎机

**玩法**：
- 消耗 30 积分 / 使用老虎机券
- 3 个滚轴转动
- 中奖判定：两连、三连

**符号配置**：
- 每个符号有独立倍率
- 支持特殊组合规则
- 支持大奖符号设置

---

### 4.8 积分商城

#### 4.8.1 商品类型

| 类型 | 示例 | 用途 |
|------|------|------|
| 抽奖券 | lottery_ticket | 免费抽奖 1 次 |
| 刮刮乐券 | scratch_ticket | 免费刮卡 1 张 |
| 扭蛋券 | gacha_ticket | 免费扭蛋 1 次 |
| 老虎机券 | slot_ticket | 免费转 1 次 |
| API Key | api_key | 额度兑换码 |

#### 4.8.2 兑换限制

- 每人每日限购（可配置）
- 每人总限购（可配置）
- 库存限制（可配置）

---

### 4.9 竞猜系统

#### 4.9.1 竞猜流程

```
创建市场 (DRAFT)
    │
    ▼
开放下注 (OPEN)
    │
    ├── 用户下注
    ├── 赔率动态更新
    └── 奖池累计
    │
    ▼
关闭下注 (CLOSED)
    │
    ▼
公布结果 + 派奖 (SETTLED)
```

#### 4.9.2 赔率计算

```
某选项赔率 = 总奖池 / 该选项总下注额

派奖金额 = 用户下注额 × 赔率 × (1 - 平台抽成)
```

#### 4.9.3 平台抽成

默认 5%，可在后台配置

---

### 4.10 成就系统

#### 4.10.1 成就分类

| 分类 | 示例成就 |
|------|----------|
| 打气相关 | 打气小能手（给 10 位选手打气） |
| 社交互动 | 人气之星（收到 50 次打气） |
| 留存活跃 | 坚持签到（连续签到 30 天） |
| 探索发现 | 尝鲜者（参与 5 种活动） |

#### 4.10.2 徽章稀有度

| 等级 | 颜色 | 兑换积分 |
|------|------|----------|
| 青铜 | 棕色 | 50 |
| 白银 | 银色 | 100 |
| 黄金 | 金色 | 200 |
| 铂金 | 紫色 | 500 |

#### 4.10.3 徽章展示

用户可选择最多 3 个徽章展示在个人资料

---

### 4.11 任务系统

#### 4.11.1 任务周期

- **日任务**：每日 00:00 重置
- **周任务**：每周一 00:00 重置

#### 4.11.2 任务类型

| 类型 | 示例 |
|------|------|
| SIGNIN | 每日签到 1 次 |
| CHEER | 给选手打气 3 次 |
| VOTE | 投票 5 次 |
| LOTTERY | 参与抽奖 2 次 |
| PREDICTION | 参与竞猜 1 次 |

#### 4.11.3 任务奖励

- 单任务奖励：完成后领取积分
- 链条奖励：完成一组任务额外奖励

---

### 4.12 管理后台

#### 4.12.1 用户管理

- 查看用户列表
- 编辑用户资料（用户名/昵称/邮箱）
- 修改用户角色
- 禁用/启用账号
- 调整用户积分

#### 4.12.2 比赛管理

- 创建/编辑比赛
- 设置各阶段时间
- 查看报名统计
- 批量审核报名

#### 4.12.3 活动配置

- 抽奖奖池配置
- 扭蛋奖品配置
- 老虎机规则配置
- 商城商品配置

#### 4.12.4 数据统计

- 用户活跃数据
- 积分流通统计
- 活动参与统计

---

## 5. 亮点功能：码神挑战

### 5.1 功能概述

**码神挑战**是平台的特色互动功能，共 **42 关**谜题，涵盖程序员必备的编码知识、开发者工具使用技巧、密码学基础等内容。玩家需要运用前端调试技能、编程知识来解谜通关。

### 5.2 设计理念

| 维度 | 设计目标 |
|------|----------|
| **教育性** | 寓教于乐，学习 ASCII、Unicode、Base64、HTTP 状态码等知识 |
| **趣味性** | 解谜形式，激发好奇心和成就感 |
| **技术性** | 需要使用浏览器 DevTools，培养调试能力 |
| **社区性** | 排行榜竞争，激发挑战欲望 |

### 5.3 关卡分类

#### 第一阶段：编码基础（第 1-9 关）

| 关卡 | 主题 | 知识点 |
|------|------|--------|
| 1 | 最熟悉，也最陌生 | ASCII 码 → HelloWorld |
| 2 | 机器的母语 | 二进制 → Hi |
| 3 | 兔子的秘密 | 斐波那契数列 |
| 4 | 调色板的暗号 | CSS 十六进制颜色码 |
| 5 | 世界上最远的距离 | 二进制加法 1+1=10 |
| 6 | 网址的面具 | URL 编码（%XX） |
| 7 | 服务器的表情包 | HTTP 状态码 200/500/404 |
| 8 | 网络的门牌号 | 常用端口号 80/443/22 |
| 9 | 邮件的暗语 | Base64 编码 |

#### 第二阶段：DevTools 实战（第 10-20 关）

| 关卡 | 主题 | 技能点 |
|------|------|--------|
| 10 | 卡住的按钮 | 删除遮罩层 / pointer-events |
| 11 | 99% 进度条 | 修改 CSS width 样式 |
| 12 | 沉睡的计时器 | Console 执行 startTimer() |
| 13 | 折叠的秘密 | 修改 max-height / overflow |
| 14 | 迷路的图片 | 修复 img src 路径 |
| 15 | 失声的按钮 | 事件冒泡 / stopPropagation |
| 16 | 影子文字 | CSS 伪元素 ::after content |
| 17 | 颠倒的世界 | CSS transform scaleX(-1) |
| 18 | 无障碍通道 | aria-label 无障碍属性 |
| 19 | 被拦截的请求 | Network 面板 / 请求头 |
| 20 | 循环的真相 | 暂停动画 / 捕捉帧 |

#### 第三阶段：浏览器探索（第 21-33 关）

| 关卡 | 主题 | 技能点 |
|------|------|--------|
| 21 | 鸡哥最爱的颜色 | 颜色选择器 #FFD700 |
| 22 | 这个 URL 好奇怪 | URL Query 参数解析 |
| 23 | 网站内没有提示 | document.title 页面标题 |
| 24 | 这里什么都没有 | 隐藏文字（同色/零尺寸） |
| 25 | 神秘代码 | Unix 时间戳 → 疯狂星期四 |
| 26 | 分量 | 图片文件大小（bytes） |
| 27 | 看不见的秘密 | type="password" → type="text" |
| 28 | 看图识字 | Cookie 存储 Application 面板 |
| 29 | Debug | Console 日志查看 |
| 30 | 看不见的差异 | 不可见字符 \x00 NUL |
| 31 | 神秘文件 | 文件魔数 / 修改后缀 |
| 32 | 本地记忆 | localStorage 存储 |
| 33 | 属性的秘密 | HTML data-* 自定义属性 |

#### 第四阶段：密码与进阶（第 34-42 关）

| 关卡 | 主题 | 技能点 |
|------|------|--------|
| 34 | 篱笆上的秘密 | 栅栏密码（Rail Fence） |
| 35 | 你太美 | Unicode 编码 \u7f8e |
| 36 | 服务器的回响 | Network 面板查看 API 响应 |
| 37 | 探索 3735928559 | 十六进制 0xDEADBEEF 魔数 |
| 38 | 已知 | RC4 对称加密 + Base64 |
| 39 | 看不见的真相 | SVG overflow:hidden 隐藏 |
| 40 | 404 | 访问 404 页面找彩蛋 |
| 41 | 时间旅行者 | 重写 Date 对象 |
| 42 | 终极挑战 | 手动发送 POST 请求 |

### 5.4 奖励机制

| 里程碑 | 条件 | 奖励 |
|--------|------|------|
| **半程奖励** | 完成 21 关 | API Key（额度奖励） |
| **全程奖励** | 完成 42 关 | API Key（更高额度） |

**奖励特性**：
- 奖励从后台配置的 API Key 库存中分配
- 每种奖励每人限领 1 次（数据库唯一约束保证）
- 支持并发安全（行锁 + 唯一约束）

### 5.5 排行榜机制

**排序规则**：
1. 首先按完成关卡数降序
2. 关卡数相同则按总用时升序
3. 显示用户当前排名

**统计数据**：
- 完成关卡数
- 总用时（秒）
- 总错误次数
- 最后答题时间

### 5.6 数据同步

**进度持久化**：
- 前端 localStorage 实时保存
- 登录后自动同步到服务器
- 支持跨设备继续挑战

**同步字段**：
```json
{
  "solved_levels": [1, 2, 3, ...],
  "level_times": {"1": 30, "2": 45, ...},
  "error_counts": {"1": 2, "3": 1, ...}
}
```

### 5.7 安全设计

| 风险 | 防护措施 |
|------|----------|
| 前端答案泄露 | 部分关卡答案来自后端接口 |
| 刷排行榜 | 后端记录用时，异常数据可识别 |
| 重复领奖 | 数据库唯一约束 + 行锁 |
| 绕过验证 | 领奖时后端校验实际完成数 |

### 5.8 技术亮点

1. **多样化题型**：纯知识、交互操作、代码执行、网络请求
2. **渐进式难度**：从基础编码到密码学，逐步提升
3. **实战导向**：所有技能都是开发者日常使用的
4. **即时反馈**：答案正确立即显示解析和知识点
5. **社区互动**：排行榜激发竞争，促进讨论

### 5.9 API 端点

```
POST /puzzle/sync-progress     - 同步进度到服务器
GET  /puzzle/my-progress       - 获取我的进度
GET  /puzzle/leaderboard       - 获取排行榜
GET  /puzzle/answer            - 第36关答案接口
POST /puzzle/final             - 第42关终极接口
POST /puzzle/claim-reward      - 领取奖励
GET  /puzzle/my-rewards        - 获取已领奖励
```

---

## 6. 数据库设计

### 6.1 核心表结构

#### 用户相关
```sql
users              -- 用户主表
user_points        -- 积分余额
user_achievements  -- 成就进度
user_exchange_quotas -- 券额度
```

#### 比赛相关
```sql
contests           -- 比赛表
registrations      -- 报名表
submissions        -- 作品提交
submission_attachments -- 附件
submission_reviews -- 评审评分
votes              -- 投票
```

#### 部署与评审
```sql
projects                 -- 作品（部署体系）
project_submissions       -- 部署提交
project_review_assignments -- 评审分配
project_reviews           -- 评审评分
project_likes             -- 作品点赞
project_favorites         -- 作品收藏
```

#### 互动相关
```sql
cheers             -- 打气记录
cheer_stats        -- 打气统计
```

#### 积分系统
```sql
points_ledger      -- 积分账本
daily_signins      -- 签到记录
signin_milestones  -- 签到里程碑
```

#### 活动系统
```sql
lottery_configs    -- 抽奖配置
lottery_prizes     -- 抽奖奖池
lottery_draws      -- 抽奖记录
scratch_cards      -- 刮刮乐
gacha_*            -- 扭蛋相关
slot_machine_*     -- 老虎机相关
```

#### 兑换系统
```sql
exchange_items     -- 商品配置
exchange_records   -- 兑换记录
api_key_codes      -- API Key 库存
```

#### 竞猜系统
```sql
prediction_markets -- 竞猜市场
prediction_options -- 竞猜选项
prediction_bets    -- 下注记录
```

#### 任务系统
```sql
task_definitions   -- 任务定义
user_task_progress -- 任务进度
user_task_claims   -- 领取记录
```

---

## 7. 前端页面架构

### 7.1 页面路由

| 路由 | 页面 | 说明 |
|------|------|------|
| `/` | 首页 | 比赛介绍、快速入口 |
| `/login` | 登录页 | 本地登录 + OAuth |
| `/register` | 注册页 | 本地注册 |
| `/reset-password` | 重置密码 | 邮件重置 |
| `/account/security` | 账号安全 | 修改/设置密码、第三方绑定 |
| `/role-guide` | 角色选择 | 新用户引导 |
| `/activity` | 活动中心 | 所有小游戏 |
| `/tasks` | 任务大厅 | 日/周任务 |
| `/achievements` | 成就系统 | 成就进度 |
| `/participants` | 选手列表 | 浏览选手 |
| `/my-project` | 参赛中心 | 我的作品 |
| `/submit` | 作品提交 | 上传材料 |
| `/submissions` | 作品展示 | 浏览作品 |
| `/projects/:projectId/access` | 作品访问入口 | 在线访问 |
| `/prediction` | 竞猜市场 | 下注竞猜 |
| `/ranking` | 排行榜 | 多维榜单（含评审榜） |
| `/ranking/review/:projectId` | 评审榜详情 | 单个作品评审数据 |
| `/announcement` | 公示页 | 评审榜公示 |
| `/review-center` | 评审中心 | 评审专用 |
| `/admin/dashboard` | 管理后台 | 运营与管理 |
| `/admin/review` | 评审后台 | 报名审核 |
| `/admin/activity` | 活动配置 | 签到/抽奖/扭蛋/商城配置 |

### 7.2 组件架构

```
src/
├── components/
│   ├── activity/      # 活动组件
│   │   ├── GachaMachine.jsx
│   │   ├── ScratchCard.jsx
│   │   ├── SlotMachine.jsx
│   │   ├── ExchangeShop.jsx
│   │   └── BackpackModal.jsx
│   ├── contest/       # 比赛组件
│   ├── layout/        # 布局组件
│   └── ui/            # 通用UI
├── pages/             # 页面组件
├── services/          # API 服务
├── stores/            # 状态管理
└── utils/             # 工具函数
```

---

## 8. API 设计规范

### 8.1 接口规范

- **基础路径**：`/api/v1`
- **认证方式**：Bearer Token
- **数据格式**：JSON

### 8.2 响应格式

**成功响应**：
```json
{
  "data": { ... },
  "message": "操作成功"
}
```

**错误响应**：
```json
{
  "detail": "错误信息",
  "status_code": 400
}
```

### 8.3 主要接口分类

| 模块 | 前缀 | 说明 |
|------|------|------|
| 认证 | `/auth` | 登录/注册/刷新/找回密码/账号绑定 |
| 用户 | `/users` | 用户信息 |
| 比赛 | `/contests` | 比赛管理 |
| 报名 | `/registrations` | 报名管理 |
| 作品 | `/submissions` | 旧作品提交体系 |
| 作品部署 | `/projects` | 作品部署与访问 |
| 投票 | `/votes` | 投票功能 |
| 评审中心 | `/review-center` | 评审中心与评分 |
| 积分 | `/points` | 积分系统 |
| 抽奖 | `/lottery` | 抽奖功能 |
| 扭蛋 | `/gacha` | 扭蛋功能 |
| 老虎机 | `/slot` | 老虎机 |
| 兑换 | `/exchange` | 积分商城 |
| 竞猜 | `/prediction` | 竞猜系统 |
| 任务 | `/tasks` | 任务系统 |
| 成就 | `/achievements` | 成就系统 |
| 管理 | `/admin` | 管理后台 |

---

## 9. 部署与运维

### 9.1 部署架构

```
GitHub Push
    │
    ▼
Webhook 触发
    │
    ▼
自动拉取代码
    │
    ▼
Docker 重新构建
    │
    ▼
服务自动重启
```

> 详见 `docs/AUTO_DEPLOY.md`。

### 9.2 环境配置

**后端 `.env`**：
```bash
DEBUG=false
SECRET_KEY=your-secret-key
DATABASE_URL=mysql+aiomysql://user:pass@host:3306/db
REDIS_URL=redis://host:6379/0
FRONTEND_URL=https://your-domain.com
LINUX_DO_CLIENT_ID=xxx
LINUX_DO_CLIENT_SECRET=xxx
```

**前端 `.env`**：
```bash
VITE_API_URL=/api/v1
```

> 更多环境变量（如 SMTP、验证码、安全挑战、上传配额、Worker 等）见 `backend/.env.example`。

### 9.3 定时任务

| 任务 | 频率 | 功能 |
|------|------|------|
| GitHub 数据同步 | 每小时 | 更新选手 GitHub 统计 |
| 每日战报 | 23:55 | 生成当日数据汇总 |

---

## 10. 业务流程图

### 10.1 用户完整旅程

```
┌─────────────────────────────────────────────────────────────┐
│                        用户旅程                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  访问首页 ──→ 登录/注册（本地或 OAuth） ──→ 角色选择 ──→ 进入平台 │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    每日行为                          │   │
│  │                                                      │   │
│  │  签到 ──→ 领取积分 ──→ 参与活动 ──→ 完成任务         │   │
│  │                                                      │   │
│  │  ┌────────┬────────┬────────┬────────┐             │   │
│  │  │ 抽奖   │ 刮刮乐 │ 扭蛋   │ 老虎机 │             │   │
│  │  └────────┴────────┴────────┴────────┘             │   │
│  │                                                      │   │
│  │  兑换商城 ←── 积分 ──→ 竞猜下注                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   参赛者行为                         │   │
│  │                                                      │   │
│  │  报名参赛 ──→ 提交作品 ──→ 等待评审 ──→ 参与投票    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   互动行为                           │   │
│  │                                                      │   │
│  │  浏览作品 ──→ 投票支持 ──→ 给选手打气 ──→ 查看排行  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  解锁成就 ←── 累计行为 ──→ 领取徽章 ──→ 展示个人资料      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 10.2 积分流通闭环

```
┌─────────────────────────────────────────────────────────────┐
│                      积分经济系统                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────┐                    ┌─────────────┐       │
│   │   积分获取   │                    │   积分消费   │       │
│   ├─────────────┤                    ├─────────────┤       │
│   │ 注册奖励    │                    │ 抽奖 (20)   │       │
│   │ 每日签到    │                    │ 刮刮乐 (20) │       │
│   │ 里程碑奖励  │                    │ 扭蛋 (50)   │       │
│   │ 接收打气    │ ───→  余额  ───→  │ 老虎机 (30) │       │
│   │ 竞猜获胜    │                    │ 竞猜下注    │       │
│   │ 成就奖励    │                    │ 商城兑换    │       │
│   │ 任务奖励    │                    │             │       │
│   └─────────────┘                    └─────────────┘       │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                    兑换系统                          │   │
│   │                                                      │   │
│   │   积分 ──→ 抽奖券/扭蛋券/刮刮乐券 ──→ 免费游玩      │   │
│   │                                                      │   │
│   │   积分 ──→ API Key ──→ 实际价值                     │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 11. 常见问题

**Q: 点赞/收藏按钮不可用？**  
A: 仅支持已上线作品，未上线的作品不开放互动。

**Q: 评审榜得分如何计算？**  
A: 评分人数≥3 时去掉最高分与最低分后取平均，否则取平均分。

**Q: 公示页为空怎么办？**  
A: 说明尚未产生评审结果或暂无上线作品，请先完成评审与发布。

---

## 附录

### A. 枚举值参考

#### 用户角色 (UserRole)
- `admin` - 管理员
- `reviewer` - 评审员
- `contestant` - 参赛者
- `spectator` - 观众

#### 比赛阶段 (ContestPhase)
- `upcoming` - 即将开始
- `signup` - 报名中
- `submission` - 提交作品
- `voting` - 投票中
- `ended` - 已结束

#### 报名状态 (RegistrationStatus)
- `draft` - 草稿
- `submitted` - 已提交
- `approved` - 已通过
- `rejected` - 已拒绝
- `withdrawn` - 已撤回

#### 积分变动原因 (PointsReason)
共 26 种，包括：
- `register_bonus` - 注册奖励
- `daily_signin` - 每日签到
- `signin_milestone` - 签到里程碑
- `lottery_cost` / `lottery_win` - 抽奖消费/中奖
- `gacha_cost` / `gacha_win` - 扭蛋消费/中奖
- `slot_cost` / `slot_win` - 老虎机消费/中奖
- `prediction_bet` / `prediction_win` - 竞猜下注/获胜
- `exchange_cost` - 商城兑换
- `cheer_received` - 接收打气
- `achievement_claim` - 成就领取
- `task_claim` - 任务领取
- `admin_adjust` - 管理员调整
- ...

---

> 文档版本：v1.0
>
> 最后更新：2025-12-24
